<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡ï¸ å°æ–°çš„è¶…èƒ½åŠ›æ‰¹æ¬¡ç›¸ç°¿ç®¡ç†ä¸­å¿ƒï¼</title>
    <style>
        /* ğŸ–ï¸ è Ÿç­†å°æ–°å‹•ç•«é¢¨æ ¼ CSS - èª¿æ•´ç‚ºç®¡ç†ä»‹é¢é¢¨æ ¼ */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@700;900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #f7e6f6; /* è Ÿç­†ç²‰è‰²èª¿ */
            color: #333;
            min-height: 100vh;
        }
        .container {
            background-color: #fff;
            padding: 40px 30px;
            border-radius: 20px;
            border: 4px solid #1a1a1a; 
            box-shadow: 10px 10px 0 #ff69b4; 
            max-width: 900px; /* æ“´å¤§å¯¬åº¦ */
            width: 100%;
            text-align: center;
            margin-bottom: 30px;
        }
        h1 {
            color: #ff0000; 
            font-size: 2.5em;
            text-shadow: 2px 2px 0 #ffff00; 
            margin-bottom: 10px;
        }
        
        /* é é¢ä¸»è¦æŒ‰éˆ•æ¨£å¼ */
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
            border-bottom: 3px dashed #ff69b4;
        }
        button {
            padding: 12px 20px;
            font-size: 1em;
            background-color: #007bff;
            color: white;
            border: 3px solid #1a1a1a; 
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            border-radius: 8px;
            font-weight: 900;
        }
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        button:active:not(:disabled) {
            transform: translate(2px, 2px);
            box-shadow: 0 0 0 #1a1a1a;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* ç›¸ç°¿åˆ—è¡¨æ¨£å¼ */
        #albumList {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
            text-align: left;
        }
        .album-card {
            background-color: #fff0f5;
            border: 3px solid #1a1a1a;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 5px 5px 0 rgba(255, 105, 180, 0.5);
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }
        .album-card:hover {
            transform: translateY(-5px);
            box-shadow: 7px 7px 0 #ff69b4;
        }
        .album-card h3 {
            color: #ff0000;
            margin-top: 0;
            margin-bottom: 5px;
            font-size: 1.3em;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .album-card p {
            font-size: 0.9em;
            color: #444;
            margin: 0;
        }
        .album-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
        }
        .album-actions button {
            padding: 5px 8px;
            font-size: 0.8em;
            border-width: 2px;
            margin-top: 0;
            background-color: #f0f0f0;
            color: #333;
        }
        .album-actions button.delete {
            background-color: #ffcccc;
        }
        
        /* è¨Šæ¯èˆ‡æ¨¡æ…‹æ¡† (Modal) æ¨£å¼ */
        .message-box { /* ä¿æŒèˆ‡åŸæœ‰çš„ä¸Šå‚³è¨Šæ¯æ¨£å¼ä¸€è‡´ */
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            text-align: left;
        }
        .success { background-color: #d4edda; color: #155724; border: 2px solid #155724;}
        .error { background-color: #f8d7da; color: #721c24; border: 2px solid #721c24;}
        .loading { background-color: #ffeeba; color: #856404; border: 2px solid #856404;}

        /* æ¨¡æ…‹æ¡† (æ–°å¢ç›¸ç°¿) */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 10; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fff;
            margin: 5% auto; 
            padding: 30px;
            border: 5px solid #1a1a1a;
            border-radius: 15px;
            width: 80%;
            max-width: 400px;
            box-shadow: 8px 8px 0 #ff69b4;
            position: relative;
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: #ff0000;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-content input {
            width: 90%;
            padding: 10px;
            margin: 10px 0 20px 0;
            border: 2px solid #1a1a1a;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ‘¶ å°æ–°çš„ç›¸ç°¿ç®¡ç†ä¸­å¿ƒï¼</h1>

        <div class="action-bar">
            <h2>æ‰€æœ‰ç›¸ç°¿</h2>
            <button id="showAddAlbumModal" onclick="document.getElementById('addAlbumModal').style.display='block'">+ æ–°å¢ç›¸ç°¿</button>
        </div>

        <div id="albumList">
            </div>

        <div id="message" class="message-box success" style="display: none;"></div>

        <hr style="margin-top: 40px; border: 1px solid #ddd;">

        <div id="uploadSection" style="margin-top: 30px; padding-top: 20px; border-top: 3px dashed #1a1a1a;">
            <h2>â¬†ï¸ æ‰¹æ¬¡ä¸Šå‚³æ–°ç…§ç‰‡</h2>
            <p>ç…§ç‰‡å°‡é è¨­ä¸Šå‚³åˆ° **æœªåˆ†é¡ç›¸ç°¿**ã€‚</p>
            <div id="dropArea" style="border: 3px dashed #007bff; padding: 30px; margin-bottom: 20px; background-color: #e6f7ff;">
                <input type="file" id="photoFile" accept="image/*,video/*" multiple>
                <p style="font-size: 1.2em;">æŠŠç…§ç‰‡/å½±ç‰‡æ‹–æ›³åˆ°é€™è£¡ï¼<br>æˆ–é»æ“Šæ­¤è™•é¸å–æª”æ¡ˆ</p>
                <div id="fileList" class="file-list" style="display: none;">å·²é¸æ“‡æª”æ¡ˆåˆ—è¡¨ï¼š</div>
            </div>
            <button id="uploadButton" onclick="uploadPhoto()">é–‹å§‹ä¸Šå‚³ (ç™¼å°„ï¼)</button>
        </div>
    </div>
    
    <div id="addAlbumModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('addAlbumModal').style.display='none'">&times;</span>
            <h2>æ–°å¢ç›¸ç°¿</h2>
            <input type="text" id="newAlbumName" placeholder="è¼¸å…¥ç›¸ç°¿åç¨±ï¼Œä¾‹å¦‚ï¼šæ˜¥æ—¥éƒ¨é˜²è¡›éšŠ" required>
            <button onclick="addNewAlbum()">ç¢ºèªæ–°å¢</button>
        </div>
    </div>


    <script>
        // âœ¨ âœ¨ âœ¨ é€™è£¡æ˜¯ä½ å¾Œç«¯æœå‹™çš„å…¬é–‹ç¶²å€ï¼ âœ¨ âœ¨ âœ¨
        const BACKEND_URL = 'https://myphotostorage-backend.zeabur.app'; // è«‹æ›¿æ›æˆæ‚¨çš„å¯¦éš›ç¶²å€
        
        const albumListElement = document.getElementById('albumList');
        const messageElement = document.getElementById('message');
        const fileInput = document.getElementById('photoFile');
        const fileListElement = document.getElementById('fileList');
        const uploadButton = document.getElementById('uploadButton');
        const dropArea = document.getElementById('dropArea');
        let selectedFiles = []; 


        // --- è¼”åŠ©å‡½å¼ ---

        function showMessage(type, content) {
            messageElement.className = `message-box ${type}`;
            messageElement.innerHTML = content;
            messageElement.style.display = 'block';
            // è‡ªå‹•éš±è—è¨Šæ¯ (3ç§’å¾Œ)
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 3000);
        }

        // --- ç›¸ç°¿ç®¡ç†é‚è¼¯ ---

        /** å–å¾—ä¸¦æ¸²æŸ“æ‰€æœ‰ç›¸ç°¿åˆ—è¡¨ */
        async function fetchAlbums() {
            try {
                albumListElement.innerHTML = '<p class="loading-text">è¼‰å…¥ä¸­...</p>';
                const response = await fetch(`${BACKEND_URL}/api/albums`);
                const albums = await response.json();

                albumListElement.innerHTML = ''; // æ¸…ç©ºåˆ—è¡¨
                
                if (albums.length === 0) {
                    albumListElement.innerHTML = '<p>å°šæœªå»ºç«‹ä»»ä½•ç›¸ç°¿ã€‚</p>';
                    return;
                }

                albums.forEach(album => {
                    const albumCard = document.createElement('div');
                    albumCard.className = 'album-card';
                    albumCard.setAttribute('data-id', album._id);

                    // é»æ“Šå¡ç‰‡æŸ¥çœ‹å…§å®¹ (ç›®å‰åªæ˜¯å½ˆå‡ºè¨Šæ¯)
                    albumCard.onclick = () => viewAlbumContent(album);

                    let actionsHtml = '';
                    // åªæœ‰éã€Œæœªåˆ†é¡ç›¸ç°¿ã€æ‰å…è¨±åˆªé™¤
                    if (album.name !== 'æœªåˆ†é¡ç›¸ç°¿') {
                        actionsHtml = `
                            <div class="album-actions">
                                <button onclick="event.stopPropagation(); deleteAlbum('${album._id}', '${album.name}')" class="delete">ğŸ—‘ï¸ åˆªé™¤</button>
                            </div>
                        `;
                    }


                    albumCard.innerHTML = `
                        ${actionsHtml}
                        <h3>${album.name}</h3>
                        <p>ç…§ç‰‡æ•¸é‡: ${album.photoCount}</p>
                        <p>å»ºç«‹æ–¼: ${new Date(album.createdAt).toLocaleDateString()}</p>
                    `;
                    albumListElement.appendChild(albumCard);
                });
            } catch (error) {
                console.error('è¼‰å…¥ç›¸ç°¿åˆ—è¡¨å¤±æ•—:', error);
                showMessage('error', 'ğŸš¨ ç„¡æ³•è¼‰å…¥ç›¸ç°¿åˆ—è¡¨ï¼Œè«‹æª¢æŸ¥å¾Œç«¯æœå‹™æ˜¯å¦æ­£å¸¸ã€‚');
            }
        }

        /** æ–°å¢ç›¸ç°¿ */
        async function addNewAlbum() {
            const name = document.getElementById('newAlbumName').value.trim();
            if (!name) {
                alert('ç›¸ç°¿åç¨±ä¸èƒ½ç‚ºç©ºï¼');
                return;
            }

            try {
                const response = await fetch(`${BACKEND_URL}/api/albums`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showMessage('success', `âœ… ç›¸ç°¿ã€Œ${name}ã€æ–°å¢æˆåŠŸï¼`);
                    document.getElementById('addAlbumModal').style.display = 'none';
                    document.getElementById('newAlbumName').value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
                    fetchAlbums(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    showMessage('error', `âŒ æ–°å¢å¤±æ•—ï¼š${result.error || 'æœªçŸ¥éŒ¯èª¤'}`);
                }

            } catch (error) {
                console.error('æ–°å¢ç›¸ç°¿å¤±æ•—:', error);
                showMessage('error', 'ğŸš¨ ç¶²è·¯é€£ç·šéŒ¯èª¤ï¼Œç„¡æ³•æ–°å¢ç›¸ç°¿ã€‚');
            }
        }

        /** åˆªé™¤ç›¸ç°¿ */
        async function deleteAlbum(albumId, albumName) {
            if (!confirm(`âš ï¸ ç¢ºå®šè¦åˆªé™¤ç›¸ç°¿ã€Œ${albumName}ã€å—ï¼Ÿ\nç›¸ç°¿å…§æ‰€æœ‰ç…§ç‰‡å°‡æœƒè¢«ç§»åˆ°ã€Œæœªåˆ†é¡ç›¸ç°¿ã€ï¼`)) {
                return;
            }

            try {
                const response = await fetch(`${BACKEND_URL}/api/albums/${albumId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showMessage('success', `âœ… ${result.message}`);
                    fetchAlbums(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    showMessage('error', `âŒ åˆªé™¤å¤±æ•—ï¼š${result.error || 'æœªçŸ¥éŒ¯èª¤'}`);
                }

            } catch (error) {
                console.error('åˆªé™¤ç›¸ç°¿å¤±æ•—:', error);
                showMessage('error', 'ğŸš¨ ç¶²è·¯é€£ç·šéŒ¯èª¤ï¼Œç„¡æ³•åˆªé™¤ç›¸ç°¿ã€‚');
            }
        }

        /** æŸ¥çœ‹ç›¸ç°¿å…§å®¹ (ç›®å‰ç‚ºç°¡åŒ–ç‰ˆæœ¬) */
        function viewAlbumContent(album) {
            // TODO: åœ¨æ›´è¤‡é›œçš„å–®é æ‡‰ç”¨ä¸­ï¼Œé€™è£¡æ‡‰è©²æ˜¯å°å‘åˆ° /album/:id é é¢ä¸¦è¼‰å…¥ç…§ç‰‡
            showMessage('loading', `è¼‰å…¥ç›¸ç°¿ã€Œ${album.name}ã€ä¸­... (API Call: GET /api/albums/${album._id}/photos)`);
            
            // æ¨¡æ“¬è¼‰å…¥éç¨‹ï¼Œä¸¦ä½¿ç”¨ alert æç¤º
            setTimeout(async () => {
                // é€™è£¡æˆ‘å€‘å¯¦éš›å‘¼å« API é©—è­‰åŠŸèƒ½
                try {
                    const response = await fetch(`${BACKEND_URL}/api/albums/${album._id}/photos`);
                    const photos = await response.json();

                    alert(`å³å°‡è·³è½‰åˆ°ç›¸ç°¿ã€Œ${album.name}ã€çš„è©³ç´°å…§å®¹é ã€‚\nè©²ç›¸ç°¿æœ‰ ${photos.length} å¼µç…§ç‰‡ã€‚\n\n(æ­¤è™•æ‡‰æ˜¯ç…§ç‰‡åˆ—è¡¨é é¢)`);
                    showMessage('success', `æˆåŠŸè¼‰å…¥ç›¸ç°¿ã€Œ${album.name}ã€è³‡è¨Šã€‚`);
                } catch (error) {
                     showMessage('error', `è¼‰å…¥ç…§ç‰‡å¤±æ•—: ${error.message}`);
                }
            }, 1000);
        }

        // --- æ‰¹æ¬¡ä¸Šå‚³é‚è¼¯ (æ²¿ç”¨ä¸¦ä¿®æ”¹è¨Šæ¯é¡¯ç¤º) ---

        // é»æ“Šæ‹–æ›³å€åŸŸæ™‚ï¼Œè§¸ç™¼æª”æ¡ˆé¸æ“‡
        dropArea.addEventListener('click', () => fileInput.click());
        // æ‹–æ›³é€²å…¥
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('drag-over');
        });
        // æ‹–æ›³é›¢é–‹
        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('drag-over');
        });
        // æª”æ¡ˆæ”¾é–‹ (Drop)
        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            handleFiles(files);
        });
        // æª”æ¡ˆé¸æ“‡è®Šæ›´ (Change)
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            selectedFiles = Array.from(files);
            updateFileListDisplay();
        }

        function updateFileListDisplay() {
            if (selectedFiles.length === 0) {
                fileListElement.style.display = 'none';
                uploadButton.disabled = true;
                return;
            }
            fileListElement.style.display = 'block';
            uploadButton.disabled = false;
            
            let listHTML = `<p>å·²é¸å– **${selectedFiles.length}** å€‹æª”æ¡ˆï¼š</p><ul>`;
            selectedFiles.forEach(file => {
                listHTML += `<li>${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</li>`;
            });
            listHTML += '</ul>';
            fileListElement.innerHTML = listHTML;
        }

        async function uploadPhoto() {
            if (selectedFiles.length === 0) {
                showMessage('error', 'âŒ è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼');
                return;
            }

            uploadButton.disabled = true;
            showMessage('loading', `ğŸš€ æ­£åœ¨ä¸Šå‚³ **${selectedFiles.length}** å€‹æª”æ¡ˆï¼Œè«‹ç­‰å¾…å°æ–°ç™¼åŠŸ...`);

            const formData = new FormData();
            selectedFiles.forEach(file => {
                formData.append('photos', file); 
            });

            try {
                const response = await fetch(`${BACKEND_URL}/upload`, {
                    method: 'POST',
                    body: formData 
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    let successCount = result.results.filter(item => item.status === 'success').length;
                    
                    let successHTML = `âœ… **ä¸Šå‚³å¤§æˆåŠŸï¼** æˆåŠŸä¸Šå‚³ ${successCount} å€‹æª”æ¡ˆã€‚<br><hr>`;
                    result.results.forEach(item => {
                        const statusClass = item.status === 'success' ? 'ok' : 'fail';
                        const statusText = item.status === 'success' ? 'âœ”ï¸ æˆåŠŸ' : `âŒ å¤±æ•—ï¼š${item.error}`;
                        successHTML += `<div class="result-item ${statusClass}">${statusText} - ${item.fileName}</div>`;
                    });
                    
                    showMessage('success', successHTML);
                    
                    // æˆåŠŸå¾Œåˆ·æ–°ç›¸ç°¿åˆ—è¡¨ï¼Œå› ç‚ºæœªåˆ†é¡ç›¸ç°¿çš„è¨ˆæ•¸å™¨è®Šäº†
                    fetchAlbums();
                    
                    // æ¸…é™¤æª”æ¡ˆåˆ—è¡¨
                    selectedFiles = [];
                    updateFileListDisplay();
                } else {
                    showMessage('error', `âŒ ä¸Šå‚³éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼è¨Šæ¯ï¼š${result.error || 'æœªçŸ¥éŒ¯èª¤'}`);
                }
            } catch (error) {
                console.error(error);
                showMessage('error', `ğŸš¨ ç™¼ç”Ÿç¶²è·¯é€£ç·šéŒ¯èª¤ï¼è«‹ç¢ºèªå¾Œç«¯æœå‹™æ˜¯å¦æ­£å¸¸é‹è¡Œã€‚`);
            } finally {
                uploadButton.disabled = false;
            }
        }
        
        // --- åˆå§‹åŒ– ---
        
        // é—œé–‰ Modal é‚è¼¯
        window.onclick = function(event) {
            const modal = document.getElementById('addAlbumModal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // é é¢è¼‰å…¥æ™‚ï¼Œç«‹å³è¼‰å…¥ç›¸ç°¿åˆ—è¡¨
        document.addEventListener('DOMContentLoaded', () => {
            fetchAlbums();
            updateFileListDisplay();
        });
    </script>
</body>
</html>